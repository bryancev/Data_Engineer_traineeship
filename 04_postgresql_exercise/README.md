# üìã –ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL

## üìò –û–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL. –í –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –±—ã–ª–æ —Å–∏—Å—Ç–µ–º—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Ç–∞–±–ª–∏—Ü–µ `users`, –∏ —Ç–µ–ø–µ—Ä—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

- –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö `name`, `email`, `role`;
- –•—Ä–∞–Ω–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ `users_audit`;
- –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV;
- –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Å–ø–æ—Ä—Ç —Å –ø–æ–º–æ—â—å—é —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è `pg_cron`.

## üèó –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name TEXT,
    email TEXT,
    role TEXT,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE users_audit (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    changed_by TEXT,
    field_changed TEXT,
    old_value TEXT,
    new_value TEXT
);
```

## üõ† –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è, –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—â–∞—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö `name`, `email`, `role`, –∏ –∑–∞–ø–∏—Å—ã–≤–∞—é—â–∞—è –∏—Ö –≤ —Ç–∞–±–ª–∏—Ü—É `users_audit`.

### 2. –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞

–î–æ–±–∞–≤–ª–µ–Ω `BEFORE UPDATE` —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `users`, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö.

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pg_cron

–í –æ–±—Ä–∞–∑ Docker –≤–∫–ª—é—á–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_cron`, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å:

```sql
CREATE EXTENSION IF NOT EXISTS pg_cron;
```

### 4. –≠–∫—Å–ø–æ—Ä—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ SQL-—Ñ—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è:

- –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `users_audit`, –≥–¥–µ `changed_at` —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É –¥–Ω—é;
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ CSV-—Ñ–∞–π–ª –ø–æ –ø—É—Ç–∏ `/tmp/users_audit_export_<–¥–∞—Ç–∞>.csv`.

### 5. –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫

–° –ø–æ–º–æ—â—å—é `pg_cron` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç –≤ **03:00 –Ω–æ—á–∏**:

```sql
SELECT cron.schedule(
    'daily_users_audit_export',
    '0 3 * * *',
    $$ SELECT export_today_users_audit(); $$
);
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ `pg_cron` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏ –∞–∫—Ç–∏–≤–Ω–æ | ‚úÖ |
| –ó–∞–¥–∞—á–∞ –≤ `cron.job` –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ | ‚úÖ |
| CSV-—Ñ–∞–π–ª —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≤–Ω—É—Ç—Ä–∏ Docker | ‚úÖ |
| –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ | ‚úÖ |
| –¢—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω –∫ —Ç–∞–±–ª–∏—Ü–µ `users` | ‚úÖ |
| –í—Å–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º SQL-—Ñ–∞–π–ª–µ | ‚úÖ |


## üìÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ –ø—É—Ç–∏ `/tmp` –±—É–¥–µ—Ç –ø–æ—è–≤–ª—è—Ç—å—Å—è —Ñ–∞–π–ª:

```
/tmp/users_audit_export_<YYYY-MM-DD_HH24MI>.csv
```

—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞ –ø—Ä–æ—à–µ–¥—à–∏–π –¥–µ–Ω—å.

---